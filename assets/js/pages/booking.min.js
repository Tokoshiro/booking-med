"use strict";App.Pages.Booking=function(){function initialize(){!+vars("display_cookie_notice")||(cookieconsent.initialise({palette:{popup:{background:"#ffffffbd",text:"#666666"},button:{background:"#429a82",text:"#ffffff"}},content:{message:lang("website_using_cookies_to_ensure_best_experience"),dismiss:"OK"}}),$cookieNoticeLink.replaceWith($("<a/>",{"data-toggle":"modal","data-target":"#cookie-notice-modal",href:"#",class:"cc-link",text:$cookieNoticeLink.text()}))),manageMode=vars("manage_mode"),tippy("[data-tippy-content]"),App.Utils.UI.initializeDatepicker($selectDate,{inline:!0,minDate:moment().subtract(1,"day").set({hours:23,minutes:59,seconds:59}).toDate(),maxDate:moment().add(vars("future_booking_limit"),"days").toDate(),onChange:function onChange(selectedDates){App.Http.Booking.getAvailableHours(moment(selectedDates[0]).format("YYYY-MM-DD")),updateConfirmFrame()},onMonthChange:function onMonthChange(selectedDates,dateStr,instance){setTimeout(function(){var displayedMonthMoment=moment(instance.currentYearElement.value+"-"+(+instance.monthsDropdownContainer.value+1)+"-01");App.Http.Booking.getUnavailableDates($selectProvider.val(),$selectService.val(),displayedMonthMoment.format("YYYY-MM-DD"))},500)},onYearChange:function onYearChange(selectedDates,dateStr,instance){setTimeout(function(){var displayedMonthMoment=moment(instance.currentYearElement.value+"-"+(+instance.monthsDropdownContainer.value+1)+"-01");App.Http.Booking.getUnavailableDates($selectProvider.val(),$selectService.val(),displayedMonthMoment.format("YYYY-MM-DD"))},500)}}),$selectDate[0]._flatpickr.setDate(new Date);var browserTimezone=Intl.DateTimeFormat().resolvedOptions().timeZone,isTimezoneSupported=0<$selectTimezone.find("option[value=\"".concat(browserTimezone,"\"]")).length;if($selectTimezone.val(isTimezoneSupported?browserTimezone:"UTC"),addEventListeners(),optimizeContactInfoDisplay(),manageMode)applyAppointmentData(vars("appointment_data"),vars("provider_data"),vars("customer_data")),$("#wizard-frame-1").css({visibility:"visible",display:"none"}).fadeIn();else{var selectedServiceId=App.Utils.Url.queryParam("service");selectedServiceId&&0<$selectService.find("option[value=\""+selectedServiceId+"\"]").length&&$selectService.val(selectedServiceId),$selectService.trigger("change");var selectedProviderId=App.Utils.Url.queryParam("provider");if(selectedProviderId&&0===$selectProvider.find("option[value=\""+selectedProviderId+"\"]").length)for(var index in vars("available_providers")){var provider=vars("available_providers")[index];provider.id===selectedProviderId&&0<provider.services.length&&$selectService.val(provider.services[0]).trigger("change")}selectedProviderId&&0<$selectProvider.find("option[value=\""+selectedProviderId+"\"]").length&&$selectProvider.val(selectedProviderId).trigger("change"),selectedServiceId&&selectedProviderId||1===vars("available_services").length&&1===vars("available_providers").length?($(".active-step").removeClass("active-step"),$("#step-2").addClass("active-step"),$("#wizard-frame-1").hide(),$("#wizard-frame-2").fadeIn(),$selectService.closest(".wizard-frame").find(".button-next").trigger("click"),$(document).find(".book-step:first").hide(),$(document).find(".button-back:first").css("visibility","hidden"),$(document).find(".book-step:not(:first)").each(function(index,bookStepEl){return $(bookStepEl).find("strong").text(index+1)})):$("#wizard-frame-1").css({visibility:"visible",display:"none"}).fadeIn(),prefillFromQueryParam("#first-name","first_name"),prefillFromQueryParam("#last-name","last_name"),prefillFromQueryParam("#email","email"),prefillFromQueryParam("#phone-number","phone"),prefillFromQueryParam("#address","address"),prefillFromQueryParam("#city","city"),prefillFromQueryParam("#zip-code","zip")}}function prefillFromQueryParam(field,param){var $target=$(field);$target.length&&$target.val(App.Utils.Url.queryParam(param))}function optimizeContactInfoDisplay(){var $firstCol=$("#wizard-frame-3 .field-col:first"),$firstColControls=$firstCol.find(".form-control"),$secondCol=$("#wizard-frame-3 .field-col:last"),$secondColControls=$secondCol.find(".form-control");1===$firstColControls.length&&1<$secondColControls.length&&$firstColControls.each(function(index,controlEl){$(controlEl).parent().insertBefore($secondColControls.first().parent())}),1===$secondColControls.length&&1<$firstColControls.length&&$secondColControls.each(function(index,controlEl){$(controlEl).parent().insertAfter($firstColControls.last().parent())});var $fieldCols=$(document).find("#wizard-frame-3 .field-col");$fieldCols.each(function(index,fieldColEl){var $fieldCol=$(fieldColEl);$fieldCol.find(".form-control").length||$fieldCol.hide()})}function addEventListeners(){$selectTimezone.on("change",function(){var date=$selectDate[0]._flatpickr.selectedDates[0];date&&(App.Http.Booking.getAvailableHours(moment(date).format("YYYY-MM-DD")),updateConfirmFrame())}),$selectProvider.on("change",function(event){var $target=$(event.target);App.Http.Booking.getUnavailableDates($target.val(),$selectService.val(),moment($selectDate[0]._flatpickr.selectedDates[0]).format("YYYY-MM-DD")),updateConfirmFrame()}),$selectService.on("change",function(event){var $target=$(event.target),serviceId=$selectService.val();$selectProvider.empty(),vars("available_providers").forEach(function(provider){var canServeService=0<provider.services.filter(function(providerServiceId){return+providerServiceId===+serviceId}).length;canServeService&&$selectProvider.append(new Option(provider.first_name+" "+provider.last_name,provider.id))}),1<$selectProvider.find("option").length&&"1"===vars("display_any_provider")&&$selectProvider.prepend(new Option(lang("any_provider"),"any-provider",!0,!0)),App.Http.Booking.getUnavailableDates($selectProvider.val(),$target.val(),moment($selectDate[0]._flatpickr.selectedDates[0]).format("YYYY-MM-DD")),updateConfirmFrame(),updateServiceDescription(serviceId)}),$(".button-next").on("click",function(event){var $target=$(event.currentTarget);if("1"!==$target.attr("data-step_index")||$selectProvider.val()){if("2"===$target.attr("data-step_index")&&!$(".selected-hour").length)return void($("#select-hour-prompt").length||$("<div/>",{id:"select-hour-prompt",class:"text-danger mb-4",text:lang("appointment_hour_missing")}).prependTo("#available-hours"));if("3"===$target.attr("data-step_index")){if(!validateCustomerForm())return;updateConfirmFrame()}var nextTabIndex=parseInt($target.attr("data-step_index"))+1;$target.parents().eq(1).fadeOut(function(){$(".active-step").removeClass("active-step"),$("#step-"+nextTabIndex).addClass("active-step"),$("#wizard-frame-"+nextTabIndex).fadeIn()})}}),$(".button-back").on("click",function(event){var prevTabIndex=parseInt($(event.currentTarget).attr("data-step_index"))-1;$(event.currentTarget).parents().eq(1).fadeOut(function(){$(".active-step").removeClass("active-step"),$("#step-"+prevTabIndex).addClass("active-step"),$("#wizard-frame-"+prevTabIndex).fadeIn()})}),$availableHours.on("click",".available-hour",function(event){$availableHours.find(".selected-hour").removeClass("selected-hour"),$(event.target).addClass("selected-hour"),updateConfirmFrame()}),manageMode&&($("#cancel-appointment").on("click",function(){var $cancellationReason,$cancelAppointmentForm=$("#cancel-appointment-form"),buttons=[{text:lang("close"),click:function click(event,messageModal){messageModal.dispose()}},{text:lang("confirm"),click:function click(){return""===$cancellationReason.val()?void $cancellationReason.css("border","2px solid #DC3545"):void($cancelAppointmentForm.find("#hidden-cancellation-reason").val($cancellationReason.val()),$cancelAppointmentForm.submit())}}];return App.Utils.Message.show(lang("cancel_appointment_title"),lang("write_appointment_removal_reason"),buttons),$cancellationReason=$("<textarea/>",{class:"form-control",id:"cancellation-reason",rows:"3",css:{width:"100%"}}).appendTo("#message-modal .modal-body"),!1}),$deletePersonalInformation.on("click",function(){var buttons=[{text:lang("cancel"),click:function click(event,messageModal){messageModal.dispose()}},{text:lang("delete"),click:function click(){App.Http.Booking.deletePersonalInformation(vars("customer_token"))}}];App.Utils.Message.show(lang("delete_personal_information"),lang("delete_personal_information_prompt"),buttons)})),$bookAppointmentSubmit.on("click",function(){var $acceptToTermsAndConditions=$("#accept-to-terms-and-conditions");if($acceptToTermsAndConditions.removeClass("is-invalid"),$acceptToTermsAndConditions.length&&!$acceptToTermsAndConditions.prop("checked"))return void $acceptToTermsAndConditions.addClass("is-invalid");var $acceptToPrivacyPolicy=$("#accept-to-privacy-policy");return $acceptToPrivacyPolicy.removeClass("is-invalid"),$acceptToPrivacyPolicy.length&&!$acceptToPrivacyPolicy.prop("checked")?void $acceptToPrivacyPolicy.addClass("is-invalid"):void App.Http.Booking.registerAppointment()}),$captchaTitle.on("click","button",function(){$(".captcha-image").attr("src",App.Utils.Url.siteUrl("captcha?"+Date.now()))}),$selectDate.on("mousedown",".ui-datepicker-calendar td",function(){setTimeout(function(){App.Http.Booking.applyPreviousUnavailableDates()},300)})}function validateCustomerForm(){$("#wizard-frame-3 .is-invalid").removeClass("is-invalid"),$("#wizard-frame-3 label.text-danger").removeClass("text-danger");var missingRequiredField=!1;if($(".required").each(function(index,requiredField){$(requiredField).val()||($(requiredField).addClass("is-invalid"),missingRequiredField=!0)}),missingRequiredField)return $("#form-message").text(lang("fields_are_required")),!1;if($email.val()&&!App.Utils.Validation.email($email.val()))return $email.addClass("is-invalid"),$("#form-message").text(lang("invalid_email")),!1;var phoneNumber=$phoneNumber.val();return!phoneNumber||App.Utils.Validation.phone(phoneNumber)||($phoneNumber.addClass("is-invalid"),$("#form-message").text(lang("invalid_phone")),!1)}function updateConfirmFrame(){if(""!==$availableHours.find(".selected-hour").text()){var selectedDate=$selectDate[0]._flatpickr.selectedDates[0];null!==selectedDate&&(selectedDate=App.Utils.Date.format(selectedDate,vars("date_format"),vars("time_format")));var serviceId=$selectService.val(),servicePrice="",serviceCurrency="";vars("available_services").forEach(function(service){if(+service.id===+serviceId&&0<+service.price)return servicePrice=service.price,serviceCurrency=service.currency,!1}),$(document).find(".display-selected-service").text($selectService.find("option:selected").text()).removeClass("invisible"),$(document).find(".display-selected-provider").text($selectProvider.find("option:selected").text()).removeClass("invisible"),$("#appointment-details").empty(),$("<div/>",{html:[$("<h4/>",{text:lang("appointment")}),$("<p/>",{html:[$("<span/>",{text:lang("service")+": "+$selectService.find("option:selected").text()}),$("<br/>"),$("<span/>",{text:lang("provider")+": "+$selectProvider.find("option:selected").text()}),$("<br/>"),$("<span/>",{text:lang("start")+": "+selectedDate+" "+$availableHours.find(".selected-hour").text()}),$("<br/>"),$("<span/>",{text:lang("timezone")+": "+$selectTimezone.find("option:selected").text()}),$("<br/>"),$("<span/>",{text:lang("price")+": "+servicePrice+" "+serviceCurrency,prop:{hidden:!servicePrice}})]})]}).appendTo("#appointment-details");var firstName=App.Utils.String.escapeHtml($firstName.val()),lastName=App.Utils.String.escapeHtml($lastName.val()),fullName=firstName+" "+lastName,phoneNumber=App.Utils.String.escapeHtml($phoneNumber.val()),email=App.Utils.String.escapeHtml($email.val()),address=App.Utils.String.escapeHtml($address.val()),city=App.Utils.String.escapeHtml($city.val()),zipCode=App.Utils.String.escapeHtml($zipCode.val());$("#customer-details").empty(),$("<div/>",{html:[$("<h4/>)",{text:lang("customer")}),$("<p/>",{html:[fullName?$("<span/>",{text:lang("customer")+": "+fullName}):null,fullName?$("<br/>"):null,phoneNumber?$("<span/>",{text:lang("phone_number")+": "+phoneNumber}):null,phoneNumber?$("<br/>"):null,email?$("<span/>",{text:lang("email")+": "+email}):null,email?$("<br/>"):null,address?$("<span/>",{text:lang("address")+": "+address}):null,address?$("<br/>"):null,city?$("<span/>",{text:lang("city")+": "+city}):null,city?$("<br/>"):null,zipCode?$("<span/>",{text:lang("zip_code")+": "+zipCode}):null,zipCode?$("<br/>"):null]})]}).appendTo("#customer-details");var data={};data.customer={last_name:$lastName.val(),first_name:$firstName.val(),email:$email.val(),phone_number:$phoneNumber.val(),address:$address.val(),city:$city.val(),zip_code:$zipCode.val(),timezone:$selectTimezone.val()},data.appointment={start_datetime:moment($selectDate[0]._flatpickr.selectedDates[0]).format("YYYY-MM-DD")+" "+moment($(".selected-hour").data("value"),"HH:mm").format("HH:mm")+":00",end_datetime:calculateEndDatetime(),notes:$notes.val(),is_unavailability:!1,id_users_provider:$selectProvider.val(),id_services:$selectService.val()},data.manage_mode=+manageMode,manageMode&&(data.appointment.id=vars("appointment_data").id,data.customer.id=vars("customer_data").id),$("input[name=\"post_data\"]").val(JSON.stringify(data))}}function calculateEndDatetime(){var endMoment,serviceId=$selectService.val(),service=vars("available_services").find(function(availableService){return+availableService.id===+serviceId}),selectedDate=moment($selectDate[0]._flatpickr.selectedDates[0]).format("YYYY-MM-DD"),selectedHour=$(".selected-hour").data("value"),startMoment=moment(selectedDate+" "+selectedHour);return endMoment=service.duration&&startMoment?startMoment.clone().add({minutes:parseInt(service.duration)}):moment(),endMoment.format("YYYY-MM-DD HH:mm:ss")}function applyAppointmentData(appointment,provider,customer){try{$selectService.val(appointment.id_services).trigger("change"),$selectProvider.val(appointment.id_users_provider);var startMoment=moment(appointment.start_datetime);$selectDate[0]._flatpickr.setDate(startMoment.toDate()),App.Http.Booking.getAvailableHours(startMoment.format("YYYY-MM-DD")),$lastName.val(customer.last_name),$firstName.val(customer.first_name),$email.val(customer.email),$phoneNumber.val(customer.phone_number),$address.val(customer.address),$city.val(customer.city),$zipCode.val(customer.zip_code),customer.timezone&&$selectTimezone.val(customer.timezone);var appointmentNotes=null===appointment.notes?"":appointment.notes;return $notes.val(appointmentNotes),updateConfirmFrame(),!0}catch(exc){return!1}}function updateServiceDescription(serviceId){var $serviceDescription=$("#service-description");$serviceDescription.empty();var service=vars("available_services").find(function(availableService){return+availableService.id===+serviceId});service&&($("<strong/>",{text:App.Utils.String.escapeHtml(service.name)}).appendTo($serviceDescription),service.description&&($("<br/>").appendTo($serviceDescription),$("<span/>",{html:App.Utils.String.escapeHtml(service.description).replaceAll("\n","<br/>")}).appendTo($serviceDescription)),(service.duration||0<+service.price||service.location)&&$("<br/>").appendTo($serviceDescription),service.duration&&$("<span/>",{text:"["+lang("duration")+" "+service.duration+" "+lang("minutes")+"]"}).appendTo($serviceDescription),0<+service.price&&$("<span/>",{text:"["+lang("price")+" "+service.price+" "+service.currency+"]"}).appendTo($serviceDescription),service.location&&$("<span/>",{text:"["+lang("location")+" "+service.location+"]"}).appendTo($serviceDescription))}var $cookieNoticeLink=$(".cc-link"),$selectDate=$("#select-date"),$selectService=$("#select-service"),$selectProvider=$("#select-provider"),$selectTimezone=$("#select-timezone"),$firstName=$("#first-name"),$lastName=$("#last-name"),$email=$("#email"),$phoneNumber=$("#phone-number"),$address=$("#address"),$city=$("#city"),$zipCode=$("#zip-code"),$notes=$("#notes"),$captchaTitle=$(".captcha-title"),$availableHours=$("#available-hours"),$bookAppointmentSubmit=$("#book-appointment-submit"),$deletePersonalInformation=$("#delete-personal-information"),tippy=window.tippy,moment=window.moment,manageMode=vars("manage_mode")||!1;return document.addEventListener("DOMContentLoaded",initialize),{manageMode:manageMode,initialize:initialize,updateConfirmFrame:updateConfirmFrame}}();